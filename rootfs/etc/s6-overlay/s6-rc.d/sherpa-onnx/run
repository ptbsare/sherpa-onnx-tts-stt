#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# ==============================================================================
declare config
if [[ -n "${SUPERVISOR_TOKEN-}" ]]; then
    update_var_from_config() {
        local var_name="$1"
        local config_key="$2"
        local config_value
        config_value=$(bashio::config "$config_key")

        if [[ "$config_value" != "null" && -n "$config_value" ]]; then
            eval "$var_name=\"$config_value\""
        fi
    }

    update_var_from_config "LANGUAGE" "language"
    update_var_from_config "SPEED" "speed"
    update_var_from_config "STT_MODEL" "stt_model"
    update_var_from_config "STT_USE_INT8_ONNX_MODEL" "stt_use_int8_onnx_model"
    update_var_from_config "STT_BUILTIN_AUTO_CONVERT_NUMBER" "stt_builtin_auto_convert_number"
    update_var_from_config "STT_THREAD_NUM" "stt_thread_num"
    update_var_from_config "STT_USE_ONLINE_PROCESSING" "stt_use_online_processing"
    update_var_from_config "TTS_MODEL" "tts_model"
    update_var_from_config "TTS_THREAD_NUM" "tts_thread_num"
    update_var_from_config "TTS_SPEAKER_SID" "tts_speaker_sid"
    update_var_from_config "DEBUG" "debug"

    if [ "$(bashio::config 'custom_stt_model')" != 'null' ]; then
        CUSTOM_STT_MODEL=$(bashio::config 'custom_stt_model')
    fi

    if [ "$(bashio::config 'custom_stt_model_eval')" != 'null' ]; then
        CUSTOM_STT_MODEL_EVAL=$(bashio::config 'custom_stt_model_eval')
    fi

    if [ "$(bashio::config 'custom_tts_model')" != 'null' ]; then
        CUSTOM_TTS_MODEL=$(bashio::config 'custom_tts_model')
    fi

    if [ "$(bashio::config 'custom_tts_model_eval')" != 'null' ]; then
        CUSTOM_TTS_MODEL_EVAL=$(bashio::config 'custom_tts_model_eval')
    fi
fi



# Ensure eval fields are not empty
CUSTOM_STT_MODEL_EVAL=${CUSTOM_STT_MODEL_EVAL:-'null'}
CUSTOM_TTS_MODEL_EVAL=${CUSTOM_TTS_MODEL_EVAL:-'null'}


echo "$LANGUAGE" "$SPEED"  "$STT_MODEL"  "$STT_USE_INT8_ONNX_MODEL" "$STT_BUILTIN_AUTO_CONVERT_NUMBER" "$STT_THREAD_NUM"  "$TTS_MODEL"  "$TTS_THREAD_NUM"  "$TTS_SPEAKER_SID"  "$DEBUG" "$CUSTOM_STT_MODEL" "$CUSTOM_STT_MODEL_EVAL" "$CUSTOM_TTS_MODEL" "$CUSTOM_TTS_MODEL_EVAL"
exec python3 /app/run.py \
    --language "$LANGUAGE" \
    --speed "$SPEED" \
    --stt_model "$STT_MODEL" \
    --stt_use_int8_onnx_model "$STT_USE_INT8_ONNX_MODEL" \
    --stt_builtin_auto_convert_number "$STT_BUILTIN_AUTO_CONVERT_NUMBER" \
    --stt_thread_num "$STT_THREAD_NUM" \
    --stt_use_online_processing "$STT_USE_ONLINE_PROCESSING" \
    --tts_model "$TTS_MODEL" \
    --tts_thread_num "$TTS_THREAD_NUM" \
    --tts_speaker_sid "$TTS_SPEAKER_SID" \
    --debug "$DEBUG" \
    --custom_stt_model "$CUSTOM_STT_MODEL" \
    --custom_stt_model_eval "$CUSTOM_STT_MODEL_EVAL" \
    --custom_tts_model "$CUSTOM_TTS_MODEL" \
    --custom_tts_model_eval "$CUSTOM_TTS_MODEL_EVAL"
